---
title: "J221 Final project"
author: "Ava Hu"
date: "Nov. 13, 2024"
output: html_document
---


```{r setup, include=FALSE, cache=F}
knitr::opts_chunk$set(echo = TRUE, error = TRUE, cache=TRUE, autodep = TRUE, message = FALSE, progress_bar = FALSE)

library(tidyverse) 
library(dplyr) 
library(ggplot2) 
library(knitr) 
library(psych)
library(lme4)
library(boot)
library(ggeffects) 
library(DescTools)
library(tidycensus)
library(xml2)
library(tmap)
library(tmaptools)
library(leaflet)
library(sf)
library(leaflet.extras)
library(raster)
library(tigris)
library(sp)
library(scales)
library(stringi)
library(leaflegend)


```


##Grab median age - B01002_001

```{r acs}
ca <- get_acs(geography = "county", 
              variables = "B01002_001",
              state = "CA", 
              year = 2022)
```


##Pull California counties then use view using Quick Thematic Map:


```{r cageo}
cageo <- counties(state= 'CA', progress_bar = FALSE) 
qtm(cageo)
```


## Merge the census data we grabbed with TidyCensus with the map based on GEOID


```{r explore}
head(cageo)
head(ca)
```

```{r merge, echo=FALSE}
camap <- merge(cageo, ca, by.x = "GEOID", by.y = "GEOID")
qtm(camap, "estimate")
```


## Interactive map

Define a pop-up window, set palette:

```{r imap}
capopup <- paste0("<b>COUNTY: ", camap$NAMELSAD, "</b><br />Median Age: ", camap$estimate)
capalette <- colorNumeric(palette = "Greens", domain=camap$estimate)

leaflet(camap) %>%
  addTiles() %>%
  addPolygons(stroke=FALSE, 
              smoothFactor = 0.2, 
              fillOpacity = .8, 
              popup=capopup, color= ~capalette(camap$estimate))

```


# Change basemap

```{r base}
leaflet(camap) %>%
  addProviderTiles("Esri.WorldGrayCanvas") %>%
  addPolygons(stroke=FALSE, 
              smoothFactor = 0.2, 
              fillOpacity = .8, 
              popup=capopup, color= ~capalette(camap$estimate))
```



## Example using multiple variables


```{r multivar}
uvars <-c("B25002_001","B25002_002","B25002_003")

caunits <- get_acs(geography = "county", 
              variables = uvars,
              state = "CA", 
              year = 2022)

wide_caunits <- caunits %>%
  pivot_wider(names_from = variable, values_from = c(estimate, moe))

pretty_caunits <- wide_caunits %>% dplyr::select(GEOID,NAME,units=estimate_B25002_001, occupied = estimate_B25002_002, vacant = estimate_B25002_003)

pretty_caunits <- pretty_caunits %>% mutate(pct_occ=100*(occupied/units)) %>% 
              mutate(pct_vacant=100*(vacant/units)) 


camap <- merge(cageo, pretty_caunits, by.x = "GEOID", by.y = "GEOID")
camap <- st_transform(camap, crs = '+proj=longlat +datum=WGS84')

unitpopup <- paste0("<b>COUNTY: ", camap$NAMELSAD, "</b><br />% vacant: ", round(camap$pct_vacant,2)) #added rounding

unitpalette <- colorNumeric(palette = "Blues", domain=camap$pct_vacant)

leaflet(camap) %>%
   addProviderTiles("Esri.WorldGrayCanvas") %>%
  addPolygons(stroke=FALSE, 
              smoothFactor = 0.2, 
              fillOpacity = .8, 
              popup=unitpopup, color= ~unitpalette(camap$pct_vacant)) %>% 
  addLegend("bottomleft", pal = unitpalette, values = ~pct_vacant,
    title = "<b>Pct_vacant by county</b><br> ",
    opacity = 1
  )
```

```{r povdata}
pvars <-c("B17001_002","B17001_015","B17001_016","B17001_029","B17001_030","B17001_031","B17001_044","B17001_045","B17001_058","B17001_059","B01001_001","B01001_020","B01001_021","B01001_022","B01001_023","B01001_024","B01001_025","B01001_044","B01001_045","B01001_046","B01001_047","B01001_048","B01001_049")


alpov <- get_acs(geography = "tract", 
              variables = pvars,
              county = "Alameda",
              state = "CA", 
              year = 2022)

wide_alpov <- alpov %>%
  pivot_wider(names_from = variable, values_from = c(estimate, moe))

pretty_alpov <- wide_alpov %>% dplyr::select(GEOID, NAME, bpov = estimate_B17001_002, bpovm65 = estimate_B17001_015, bpovm75 = estimate_B17001_016, bpovf65 = estimate_B17001_029, bpovf75 = estimate_B17001_030, apov = estimate_B17001_031, apovm65 = estimate_B17001_044, apovm75 = estimate_B17001_045,apovf65 = estimate_B17001_058, apovf75 = estimate_B17001_059, agepop = estimate_B01001_001,estimate_B01001_020,estimate_B01001_021,estimate_B01001_022,estimate_B01001_023,estimate_B01001_024,estimate_B01001_025,estimate_B01001_044,estimate_B01001_045,estimate_B01001_046,estimate_B01001_047,estimate_B01001_048,estimate_B01001_049)

pretty_alpov <- pretty_alpov %>% mutate(pct_pov=round(100*bpov/(bpov+apov),1)) %>% 
              mutate(pct_65pov=round(100*(bpovm65 + bpovm75+bpovf65+bpovf75)/(bpovm65 +bpovm75+bpovf65+bpovf75+apovm65+apovm75+apovf65+apovf75),1)) %>%   
mutate(tot65up=estimate_B01001_020+estimate_B01001_021+estimate_B01001_022+estimate_B01001_023+estimate_B01001_024+estimate_B01001_025+estimate_B01001_044+estimate_B01001_045+estimate_B01001_046+estimate_B01001_047+estimate_B01001_048+estimate_B01001_049) %>% 
mutate(pct_65up=round(100*tot65up/agepop,1)) 
```


```{r alpovmap}
algeo <- tracts("CA", county = 'Alameda', progress_bar = FALSE)

almap <- merge(algeo, pretty_alpov, by.x = "GEOID", by.y = "GEOID")
almap <- st_transform(almap, crs = '+proj=longlat +datum=WGS84')

alpopup <- paste0(almap$NAMELSAD, "</b><br />% poverty: ", round(almap$pct_pov,2), "</b><br />% 65 up poverty: ", round(almap$pct_65pov,2))

alpal <- colorNumeric(palette = rev("RdYlGn"), domain=almap$pct_pov, na.color = "white",n=4)


leaflet(almap) %>%
   addProviderTiles("Esri.WorldGrayCanvas") %>%
  addPolygons(stroke=FALSE, 
              smoothFactor = 0.2, 
              fillOpacity = .9, 
              popup=alpopup, color= ~alpal(almap$pct_pov)) %>% 
  addLegend("bottomleft", pal = alpal, values = ~pct_65up,
    title = "<b>Poverty rate by tract</b><br> ",
    opacity = 1
  )
```

##Note: to set custom categories:
  alpal <- colorQuantile(palette = rev("RdYlGn"), domain=almap$pct_pov, ,n=4)

or

# Define custom breaks
  custom_breaks <- c(0, 5, 10, 15, 80, 100)

# Create a color palette with custom breaks
  alpal <- colorBin(palette = "YlGnBu", domain = almap$pct_pov, bins = custom_breaks)



## Grab shape files using TIGRIS

```
cc_trt <- tracts("CA", county = 'Contra Costa', progress_bar = FALSE)
qtm(cc_trt)
```

## Map points - from geojson file exported from QGIS

```{r pear}
pear <- st_read("~/projects/J221_week10/R data/peartrees.geojson") %>% 
  st_transform(4326) # safety of unprojected CRS

qtm(pear)
glimpse(pear)

pearpopup <- paste0("<b>TYPE: ", pear$Common_Nam, "</b><br />Height: ", pear$HEIGHT_FT)

leaflet(pear) %>%
                addTiles() %>%
                 addSymbolsSize(values = as.numeric(pear$HEIGHT_FT),
                 lat = ~Latitude, 
                 lng = ~Longitude,
                 shape = 'triangle',
                 color = 'green',
                 fillColor = 'green',
                 opacity = .5,
                 popup=pearpopup,
                 baseSize = 5) 
```




                                
